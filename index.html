<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Hub (Legacy Working Version)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial, sans-serif; background:#f5f7ff; margin:0; }
#app { max-width:900px; margin:2rem auto; background:#fff; padding:1.5rem; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.1); }
input, button { padding:.6rem; margin:.25rem 0; width:100%; }
button { background:#4f46e5; color:#fff; border:none; border-radius:4px; cursor:pointer; }
button.secondary { background:#e5e7eb; color:#111; }
.chat-box { border:1px solid #ddd; height:300px; overflow-y:auto; padding:.5rem; margin-bottom:.5rem; }
.msg { margin-bottom:.25rem; }
.msg span { font-weight:bold; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="app">Loadingâ€¦</div>

<script>
// ðŸ”¹ LEGACY WORKING VERSION WITH GUEST OPTION

const firebaseConfig = {
  apiKey: "AIzaSyCfijY0V4DQDOkrb13ludHiGRFtWsk8Bsg",
  authDomain: "student-hub-450ab.firebaseapp.com",
  databaseURL: "https://student-hub-450ab-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "student-hub-450ab",
  storageBucket: "student-hub-450ab.firebasestorage.app",
  messagingSenderId: "149361370872",
  appId: "1:149361370872:web:e3ee75310e59d92f3bbd0d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let user = null;

// Render login + signup + guest
function renderLogin() {
  document.getElementById('app').innerHTML = `
    <h2>Student Hub</h2>

    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button class="secondary" onclick="signup()">Sign Up</button>

    <hr style="margin:1rem 0;">

    <input id="guest-name" placeholder="Enter your name to join as guest">
    <button class="secondary" onclick="guestJoin()">Continue as Guest</button>
  `;
}

// Login function
function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email, password)
    .catch(err => alert(err.message));
}

// Sign up function
function signup() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const displayName = email.split('@')[0];

  auth.createUserWithEmailAndPassword(email, password)
    .then(cred => cred.user.updateProfile({ displayName }))
    .catch(err => alert(err.message));
}

// Guest join function
function guestJoin() {
  const name = document.getElementById('guest-name').value.trim();
  if (!name) return alert('Please enter a name');
  user = { uid: 'guest-' + Date.now(), name };
  renderChat();
}

// Logout
function logout() {
  auth.signOut();
}

// Render chat
function renderChat() {
  document.getElementById('app').innerHTML = `
    <h2>General Chat</h2>
    <div class="chat-box" id="chat"></div>
    <input id="msg" placeholder="Type messageâ€¦" onkeypress="if(event.key==='Enter') sendMsg()">
    <button onclick="sendMsg()">Send</button>
    <button class="secondary" onclick="logout()">Logout</button>
  `;

  db.ref('chat').limitToLast(100).on('child_added', snap => {
    const m = snap.val();
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<span>${m.name}:</span> ${m.text}`;
    const chatBox = document.getElementById('chat');
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight; // scroll to bottom
  });
}

// Send message
function sendMsg() {
  const textInput = document.getElementById('msg');
  const text = textInput.value.trim();
  if (!text) return;

  db.ref('chat').push({
    name: user.displayName || user.name || (user.email ? user.email.split('@')[0] : 'Guest'),
    text,
    time: Date.now()
  });
  textInput.value = '';
  textInput.focus();
}

// Auth state listener
auth.onAuthStateChanged(u => {
  if (u) {
    user = u;
    renderChat();
  } else {
    renderLogin();
  }
});
</script>
</body>
</html>
